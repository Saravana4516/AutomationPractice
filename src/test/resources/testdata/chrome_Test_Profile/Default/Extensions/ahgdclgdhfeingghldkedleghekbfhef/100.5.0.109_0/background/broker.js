(function(g){function e(a,b){Object(a)instanceof String&&(a={shortform:a});this.error=a;this.cause=b}function k(){this.seq=0;this.baseID=(new Date).getTime()+":"+Math.random()}if(!g)throw Error("Bad setup");var l=function(a){return(a=a.flavor)?(a=a.toLowerCase(),"com.symantec.authclient."+a+".nativemessaging.launcher"):"com.symantec.pkiclient.nativemessaging.launcher"};e.prototype=Error("BrokerException");e.prototype.toString=function(){var a="BrokerException("+this.err.shortform+")";this.cause&&
(a+="; caused by "+this.cause.toString());return a};k.prototype={getID:function(){return this.baseID+":"+this.seq++},launch:function(a){var b=this;return(new Promise(function(c,h){var d=chrome.runtime.connectNative(l(a));b.pendingCalls={};b.port=d;d.onDisconnect.addListener(function(a){b.connected=!1;console.debug("Disconnected:",a);h(new e("connect",a));if(b.initialized)b.onDisconnect(a)});var f=function(a,c){if(b.initialized)b.gotMessage(a);else if(!(0>=c))return setTimeout(function(){f(a,c-1)},
100)};d.onMessage.addListener(function(a){f(a,10)});setTimeout(function(){c()},100)})).then(function(){b.initialized=!0;b.connected=!0})["catch"](function(a){a instanceof e&&console.error("Failed to properly connect:"+a.error.shortform);throw a;})},shutdown:function(){this.connected=this.initialized=!1;if(this.port){try{this.port.disconnect()}catch(a){}delete this.port}},onDisconnect:function(a){var b=this,c=0;Object.keys(this.pendingCalls).forEach(function(a){try{c++,b.pendingCalls[a](!1,"disconnected"),
delete b.pendingCalls[a]}catch(d){console.error("Error sending disconnect error to ID="+a,d)}});console.debug("Send onDisconnect message to "+c+" pending calls")},gotMessage:function(a){if(a&&"2.0"==a.jsonrpc){var b=this.pendingCalls[a.id];b?(delete this.pendingCalls[a.id],b(!0,a)):console.error("Message had ID=",a.id,", but there were no pending calls")}else console.error("Invalid message (",a,"):",a)},sendReceive:function(a,b){var c=this;return new Promise(function(h,d){if(!c.connected)return console.error("Attempt to send message ",
a,b," on disconnected broker"),d(new e("notConnected"));var f=c.getID(),g={jsonrpc:"2.0",method:a,params:b,id:f};c.pendingCalls[f]=function(a,b,c){a?h(b):d(new e(b,c))};c.port.postMessage(g)})}};g.Broker=k})(window.pkiClientExtension);
